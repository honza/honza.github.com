<!doctype html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="description" content="Thoughts on web programming, open source hacking and the like. Honza Pokorny is a web developer in Halifax, Canada" >
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>How I back up my laptop - Honza Pokorny</title>
  <link rel="stylesheet" href="/media/screen.css" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="News-Feed" href="https://honza.ca/atom.xml" />
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-4330851-12']);
        _gaq.push(['_trackPageview']);

        (function(){
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>

</head>
<body>

    <div id="wrap">
        <div id="banner" class="body">
            <h1><a href="/">Honza Pokorny</a></h1>
        </div>
        <p>Thoughts on web programming and the world of technology</p>
        

<p class="article_date date">
    July 15, 2013, reading time: 2 minutes
</p>

<div id="content">
    <div class="section" id="how-i-back-up-my-laptop">
<h1>How I back up my&nbsp;laptop</h1>
<p>For the longest time, I was using Time Machine to keep copies of my files.  I
don&#8217;t remember ever wishing I could go back in time and retrieve an older
version of a file.  What does keep me up at night though is forever losing all
of the pictures of our kids because my hard drive&nbsp;failed.</p>
<p>I also don&#8217;t particularly like tools like Time Machine,  Carbon Copy Cloner or
SuperDuper.  They are some kind of <span class="caps">GUI</span> app that does stuff, and I like my unix&nbsp;tools.</p>
<p>Here are my requirements for a good backup&nbsp;solution:</p>
<ol class="arabic simple">
<li>Incremental - that means don&#8217;t overwrite older backups and don&#8217;t back up
everything every&nbsp;time</li>
<li>Efficient storage - I shouldn&#8217;t need 10 <span class="caps">TB</span> to keep a few backups of my hard&nbsp;drive</li>
<li>Bootable - if my hard drive fails or laptop gets stolen, I want to be able
to back to work&nbsp;quickly</li>
</ol>
<p>When you do some research into this, you will see mostly suggesting rsync.  It
can copy your entire drive and does smart, incremental backups.  Except it
overwrites stuff and you only get to keep the latest&nbsp;copy.</p>
<p>Enter <a class="reference external" href="https://github.com/bup/bup">bup</a>.  Bup is simply amazing.  It&#8217;s based on git and it gives you
automatic incremental, deduplicated, shared backups.  Free and open&nbsp;source.</p>
<p>Backing up huge virtual machines?  It only backs up what changed, not the whole
file.  Multiple copies of the same stuff on your hard drive?  Only needs to
store one copy.  Have a look at their documentation for more information about
how it works and what the benefits&nbsp;are.</p>
<p>The way you use bup is by creating a tar archive stream of all your data and
sending it to bup on stdin.  Bup takes it, chunks, deduplicates it and stores
in a git&nbsp;repo.</p>
<p>The canonical example goes like&nbsp;this:</p>
<pre class="literal-block">
tar -cvf - /etc | bup split -n local-etc
</pre>
<p>The <tt class="docutils literal"><span class="pre">-n</span></tt> flag just allows you to name your&nbsp;backup.</p>
<p>Next, we have to figure out how to tar up our entire drive.  This can be a
little tricky because there are some special files which we don&#8217;t want to copy
over.  After much trial, error and googling, I came up with the following list
of exclusions.  Note that this only applies to <span class="caps">OS</span>&nbsp;X.</p>
<pre class="literal-block">
.Spotlight-*/
.Trashes
/afs/*
/automount/*
/cores/*
/dev/*
/Network/*
/private/tmp/*
/private/var/run/*
/private/var/spool/postfix/*
/private/var/vm/*
/Previous Systems.localized
/tmp/*
/Volumes/*
*/.Trash
</pre>
<p>Save this to <tt class="docutils literal">excludes.txt</tt> and then use this tar&nbsp;command:</p>
<pre class="literal-block">
$ tar -cvf - / -X excludes.txt | bup split -n backup
</pre>
<p>This takes about 1-2h on my system (<span class="caps">128GB</span> <span class="caps">SSD</span>, <span class="caps">500GB</span> 5400rpm external).
Subsequent backups take a lot less time.  As far as actual backup goes, we&#8217;re&nbsp;done.</p>
<p>How do you&nbsp;restore?</p>
<p>The nice thing about bup is that it stores your backups in a git repository.
This means that you can go back in history and decide from which point in time
you&#8217;d like to restore.  Bup allows you to spit out a tar file like&nbsp;this:</p>
<pre class="literal-block">
$ bup join backup -o backup.tar
</pre>
<p>This will again take some time and use quite a bit of resources (git will eat
your <span class="caps">RAM</span> and <span class="caps">CPU</span> - a <span class="caps">6GB</span> git process anyone?).  Once that is done, you can
extract the tar to a drive that can be booted into.  This can be the internal
drive on a new computer or a <span class="caps">GUID</span>-partitioned external&nbsp;drive.</p>
<p>Once extracted, you just have to <em>bless</em> the data to make it&nbsp;bootable:</p>
<pre class="literal-block">
$ sudo bless -folder /System/Library/CoreServices
</pre>
<p>Then, you should reboot your Mac while holding down the Option key.  This will
show you the boot order menu and allow you to specify where you&#8217;d like to boot&nbsp;from.</p>
<p>Of course, you should wrap all of this in a script and run it&nbsp;periodically.</p>
</div>

</div>


    </div>

</body>
</html>