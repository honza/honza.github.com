<!doctype html lang="en">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="description" content="Thoughts of an open source developer with a theology degree. Honza Pokorny is a web developer and an armchair theologian in Halifax, Canada" >
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>How not to depend on PyPI | Honza Pokorny</title>
  <link href="https://fonts.googleapis.com/css?family=Karla:400,400i|Montserrat:700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://honza.cacss/index.css">
  <link rel="alternate" type="application/rss+xml" href="" title="Honza Pokorny">
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-4330851-12']);
        _gaq.push(['_trackPageview']);

        (function(){
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>

</head>
<body>
        <div id="banner" class="container">
          <h1><a href="/">Honza Pokorny</a></h1>
          <p><em>Thoughts of an open source developer with a theology degree</em></p>
        </div>

    <div id="wrap">

<div class="single-header">
  <h1>How not to depend on PyPI</h1>

</div>

<article>
  

<p>When deploying a Django application, you often use a <code>requirements.txt</code> file
that contains a list of the application&rsquo;s dependencies. During deployment, your
provisioning system will <code>pip install</code> all of those to make sure that your
application runs as desired.</p>

<p>The format of a typical <code>requirements.txt</code> files isn&rsquo;t unlike the following</p>

<pre><code class="language-nil">django==1.3.1
psycopg2==2.4.4
Fabric==1.3.3
...
</code></pre>

<p>By default, <code>pip</code> will go to the <a href="http://pypi.python.org">Python Package Index</a> (PyPI) and look for
that package there.</p>

<p>Unfortunately, PyPI has been known to be down or slow at times; and you want
your deployments to be as smooth as possible.</p>

<h2 id="what-you-can-do">What you can do</h2>

<p>Instead of depending on PyPI for a production application, you can host the
packages that your application needs yourself. It&rsquo;s actually surpringly easy to
do. Your existing deployment strategy can easily be modified to remove the
dependency.</p>

<p>First, we will create a freeze of your requirements. This will look into your
environment and figure out which version of which package you will need for the
production environment.</p>

<pre><code class="language-nil">$ pip freeze -r requirements.txt &gt; freeze.txt
</code></pre>

<p>Once you have the list of packages, you can tell <code>pip</code> to download all the
packages into a directory without installing them.</p>

<pre><code class="language-nil">$ pip install -d pypi -r freeze.txt
</code></pre>

<p>This will download all packages from <code>freeze.txt</code> into the <code>pypi/</code>
directory.</p>

<p>The next step is to upload all these packages to a publicly accessible server
that can serve static files. This can anything from S3, Cloudfiles or even
Github pages. I like to place all of these packages into a <code>packages/</code>
directory. You will also need a simple index file to go with your packages. All
the index file needs to is provide a list of HTML links to those packages. The
index will be used by <code>pip</code> to locate the package source distribution.</p>

<p>I have put together a simple Fabric task that will read the contents of the
<code>pypi/</code> directory and create this index file for you.</p>

<pre><code class="language-python">def make_index():
    result = local('ls pypi', capture=True)
    packages = result.split('\n')

    html = &quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;%s&lt;/body&gt;&lt;/html&gt;&quot;

    links = []

    for package in packages:
        link = '&lt;a href=&quot;packages/%s&quot;&gt;%s&lt;/a&gt;' % (package, package)
        links.append(link)

    links = '\n'.join(links)

    f = open('index.html', 'w')
    f.write(html % links)
    f.close()
</code></pre>

<p>Upload the index file to your server and you&rsquo;re ready to deploy. Instead of the
usual:</p>

<pre><code class="language-nil">$ pip install -r requirements.txt
</code></pre>

<p>You will run this:</p>

<pre><code class="language-nil">$ pip install -r freeze.txt -f http://yourPypiHost.com/index.html --no-index
</code></pre>

<p>This will completely ignore PyPI and only use your index when locating
packages. This way your deploys will be faster and more reliable.</p>

</article>

<p class="article_date date">
  This article was first published on February 4, 2012.  As you can see, there
  are no comments.  I invite you to email me with your comments, criticisms,
  and other suggestions.  Even better, write your own article as a response.
  Blogging is awesome.
</p>


    </div>

</body>
</html>
